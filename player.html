<script>
        // --- 1. ë”ë¯¸ ì½”ë“œ (ë””ìì¸) ---
        const dummyCode = [
            `<span class="kw">package</span> com.vscode.music;`,
            ``,
            `<span class="kw">import</span> java.util.EmotionalEngine;`,
            `<span class="kw">import</span> java.util.SyllableSync;`,
            ``,
            `<span class="kw">public class</span> <span class="cls">MusicPlayer</span> {`,
            `    <span class="kw">public static void</span> <span class="mth">main</span>(String[] args) {`,
            `        <span class="cmt">// 1. í”Œë ˆì´ì–´ ì—”ì§„ ì´ˆê¸°í™”</span>`,
            `        <span class="cls">AudioStream</span> stream = <span class="kw">new</span> <span class="cls">AudioStream</span>();`,
            `        stream.<span class="mth">connect</span>(<span class="str">"YouTube_Server"</span>);`,
            ``,
            `        <span class="cmt">// 2. ìë™ ìš°íšŒ ì ‘ì† ì‹œë„...</span>`,
            `        <span class="kw">try</span> {`,
            `            stream.<span class="mth">play</span>();`,
            `        } <span class="kw">catch</span> (<span class="cls">CopyrightException</span> e) {`,
            `            stream.<span class="mth">switchToLyricsMode</span>();`,
            `        }`,
            `    }`,
            `}`
        ];

        function renderDummyCode() {
            const area = document.getElementById('fake-code-area');
            let html = '';
            dummyCode.forEach((line, i) => {
                html += `<div><span class="line-num">${i + 1}</span>${line}</div>`;
            });
            area.innerHTML = html;
        }
        renderDummyCode();

        // --- 2. í•µì‹¬ ë¡œì§ ---
        let lyricsData = [];
        let player;
        let syncInterval;
        let lastPrintedIndex = -1;
        let currentSyllableTimeouts = [];
        let loadTimeout = null; 
        let currentSongInfo = null;
        let currentLineElement = null; 
        let isRetrying = false; // [ì¤‘ìš”] ì¬ì‹œë„ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

        function handleEnter(e) { if(e.key === 'Enter') searchMusic(); }

        async function searchMusic() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            
            const list = document.getElementById('result-list');
            list.innerHTML = '<li class="song-item">Searching...</li>';

            try {
                const response = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                const validSongs = data.filter(song => song.syncedLyrics);
                
                list.innerHTML = '';
                if (validSongs.length === 0) {
                    list.innerHTML = '<li class="song-item">No synced lyrics found.</li>';
                    return;
                }

                validSongs.forEach(song => {
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerHTML = `<span>ğŸµ ${song.artistName} - ${song.trackName}</span>`;
                    li.onclick = () => {
                        document.querySelectorAll('.song-item').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                        loadSong(song);
                    };
                    list.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                list.innerHTML = '<li class="song-item" style="color:#f44747;">Error fetching data</li>';
            }
        }

        function loadSong(song) {
            currentSongInfo = song; 
            lyricsData = parseLrc(song.syncedLyrics);
            lastPrintedIndex = -1; 
            isRetrying = false; // ì¬ì‹œë„ ìƒíƒœ ì´ˆê¸°í™”
            
            clearAllSyllableTimeouts();
            if(loadTimeout) clearTimeout(loadTimeout);

            const consoleOut = document.getElementById('console-output');
            consoleOut.innerHTML = ''; 
            
            printToConsole(`> Loading: ${song.trackName}...`);
            updateStatus(`Loading ${song.trackName}...`);

            // ì²˜ìŒì—” 'audio' ëª¨ë“œë¡œ ì‹œë„
            tryPlayMusic(song, false);
        }

        // [í•µì‹¬ ìˆ˜ì •] ëª¨ë“œì— ë”°ë¼ ê²€ìƒ‰ì–´ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
        function tryPlayMusic(song, useLyricsMode) {
            if (!playerReady) {
                printToConsole("> Waiting for YouTube Player...");
                setTimeout(() => tryPlayMusic(song, useLyricsMode), 1000);
                return;
            }
            
            // ì¼ë°˜ ëª¨ë“œë©´ 'audio', ì¬ì‹œë„(Lyrics) ëª¨ë“œë©´ 'lyrics' ê²€ìƒ‰
            let searchKeyword = useLyricsMode ? 'lyrics' : 'audio';
            const searchQ = `${song.artistName} ${song.trackName} ${searchKeyword}`;
            
            printToConsole(`> Searching: ${searchQ}...`);
            
            if(player && player.loadPlaylist) {
                player.loadPlaylist({
                    listType: 'search',
                    list: searchQ,
                    index: 0,
                    startSeconds: 0
                });
                player.setVolume(100);

                // ë¡œë”© ì²´í¬ (3ì´ˆ ë’¤ì—ë„ ì‹œì‘ ì•ˆí•˜ë©´ ìˆ˜ë™ ë²„íŠ¼)
                if(loadTimeout) clearTimeout(loadTimeout);
                loadTimeout = setTimeout(() => {
                    if(player.getPlayerState() !== 1 && player.getPlayerState() !== 3) {
                         printManualPlayButton();
                    }
                }, 4000);
            }
        }

        function printManualPlayButton() {
            if(document.getElementById('manual-play-btn')) return;

            const consoleOut = document.getElementById('console-output');
            const lineDiv = document.createElement('div');
            lineDiv.id = 'manual-play-btn';
            lineDiv.className = 'console-line';
            lineDiv.style.cursor = 'pointer';
            lineDiv.style.color = '#4ec9b0'; 
            
            lineDiv.innerHTML = `<span class="prompt">!</span> <span style="text-decoration:underline;">[ Click to Play (ì¬ìƒ ê¶Œí•œ ìš”ì²­) ]</span>`;
            
            lineDiv.onclick = () => {
                if(player && currentSongInfo) {
                    printToConsole("> Retrying playback...");
                    lineDiv.style.display = 'none';
                    // ìˆ˜ë™ í´ë¦­ ì‹œì—ë„ í˜„ì¬ ëª¨ë“œ(ì¬ì‹œë„ ì—¬ë¶€) ìœ ì§€í•˜ë©° ì¬ìƒ
                    tryPlayMusic(currentSongInfo, isRetrying);
                }
            };
            
            consoleOut.appendChild(lineDiv);
            consoleOut.scrollTop = consoleOut.scrollHeight;
        }

        function parseLrc(lrc) {
            const lines = [];
            const regex = /\[(\d+):(\d+\.\d+)\](.*)/;
            lrc.split('\n').forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const text = match[3].trim();
                    if (text) { 
                        lines.push({
                            time: parseInt(match[1]) * 60 + parseFloat(match[2]),
                            text: text
                        });
                    }
                }
            });
            return lines;
        }

        function splitIntoSyllables(text) {
            const syllables = [];
            let currentSyllable = '';
            for (let char of text) {
                if (/[\u3131-\uD79D]/.test(char) || /[a-zA-Z0-9]/.test(char)) {
                    if (currentSyllable) {
                        syllables.push(currentSyllable);
                        currentSyllable = '';
                    }
                    syllables.push(char);
                } else {
                    currentSyllable += char;
                    if (syllables.length > 0) {
                        syllables[syllables.length - 1] += char;
                        currentSyllable = '';
                    }
                }
            }
            if (currentSyllable) syllables.push(currentSyllable);
            return syllables.filter(s => s.trim());
        }

        function printToConsole(text, isLyric = false) {
            const consoleOut = document.getElementById('console-output');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'console-line';
            
            const promptSpan = document.createElement('span');
            promptSpan.className = 'prompt';
            promptSpan.textContent = '>';
            
            const textSpan = document.createElement('span');
            textSpan.className = isLyric ? 'lyrics-text' : '';
            textSpan.textContent = isLyric ? '' : text;
            
            lineDiv.appendChild(promptSpan);
            lineDiv.appendChild(textSpan);
            consoleOut.appendChild(lineDiv);
            consoleOut.scrollTop = consoleOut.scrollHeight;

            if (isLyric) currentLineElement = textSpan;
        }

        function clearAllSyllableTimeouts() {
            currentSyllableTimeouts.forEach(timeout => clearTimeout(timeout));
            currentSyllableTimeouts = [];
        }

        // --- 4. ìœ íŠœë¸Œ API & ì—ëŸ¬ í•¸ë“¤ë§ (ì—¬ê¸°ê°€ í•µì‹¬) ---
        let playerReady = false;
        
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('hidden-player', {
                height: '200', 
                width: '300',
                videoId: 'M7lc1UVf-VE', 
                playerVars: { 
                    'autoplay': 0,
                    'controls': 1,
                    'origin': window.location.origin,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        
        function onPlayerReady(event) {
            playerReady = true;
            document.getElementById('player-status').textContent = 'Player: Ready âœ“';
            printToConsole("> System Ready.");
        }

        function onPlayerError(event) {
            if (!currentSongInfo) return;

            // [ì¤‘ìš”] 150(101) ì—ëŸ¬: ì €ì‘ê¶Œ ë§‰í˜ -> ë‹¤ë¥¸ ì˜ìƒìœ¼ë¡œ ì¬ì‹œë„
            if (event.data === 150 || event.data === 101) {
                if (!isRetrying) {
                    printToConsole("! Embedding blocked by owner. Trying Lyrics version...");
                    isRetrying = true; // ì¬ì‹œë„ ëª¨ë“œ ON
                    
                    // 'audio' ëŒ€ì‹  'lyrics' í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ê²€ìƒ‰!
                    tryPlayMusic(currentSongInfo, true);
                } else {
                    printToConsole("ERROR: Even the lyrics version is blocked. Sorry.");
                }
            } 
            // 2 ì—ëŸ¬: íŒŒë¼ë¯¸í„° ì˜¤ë¥˜ (ì¬ì‹œë„)
            else if(event.data === 2) {
                printToConsole("! Connection unstable. Retrying...");
                setTimeout(() => tryPlayMusic(currentSongInfo, isRetrying), 2000);
            } 
            else {
                printToConsole("YouTube Error Code: " + event.data);
            }
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                updateStatus("Running...");
                if(loadTimeout) clearTimeout(loadTimeout);
                
                const btn = document.getElementById('manual-play-btn');
                if(btn) btn.style.display = 'none';

                if(syncInterval) clearInterval(syncInterval);
                syncInterval = setInterval(checkSync, 50);
            } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                if(event.data == YT.PlayerState.PAUSED) updateStatus("Paused");
                if(event.data == YT.PlayerState.ENDED) updateStatus("Ended");
                clearInterval(syncInterval);
                clearAllSyllableTimeouts();
            }
        }

        function checkSync() {
            if(!player || !player.getCurrentTime || lyricsData.length === 0) return;
            const currentTime = player.getCurrentTime();
            let activeIndex = -1;
            
            for(let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) activeIndex = i;
                else break;
            }

            if(activeIndex !== -1 && activeIndex !== lastPrintedIndex) {
                clearAllSyllableTimeouts();
                displayLyricWithSyllables(activeIndex);
                lastPrintedIndex = activeIndex;
            }
        }

        function displayLyricWithSyllables(index) {
            const lyric = lyricsData[index];
            const syllables = splitIntoSyllables(lyric.text);
            
            let timeToNext;
            if (index + 1 < lyricsData.length) timeToNext = lyricsData[index + 1].time - lyric.time;
            else timeToNext = syllables.length * 0.3;
            
            let timePerSyllable = Math.max(0.05, Math.min(0.5, timeToNext / syllables.length));
            
            printToConsole('', true);
            syllables.forEach((syllable, i) => {
                const timeout = setTimeout(() => {
                    if (currentLineElement) {
                        currentLineElement.textContent += syllable;
                        const consoleOut = document.getElementById('console-output');
                        consoleOut.scrollTop = consoleOut.scrollHeight;
                    }
                }, i * timePerSyllable * 1000);
                currentSyllableTimeouts.push(timeout);
            });
        }

        function updateStatus(msg) {
            document.getElementById('status-left').innerText = msg;
        }
    </script>
