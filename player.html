<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Music Player V3 (Final Fix)</title>
    <style>
        /* (ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) */
        :root { --bg-color: #1e1e1e; --sidebar-color: #252526; --terminal-bg: #1e1e1e; --text-color: #d4d4d4; --keyword: #569cd6; --string: #ce9178; --comment: #6a9955; --class-name: #4ec9b0; --method: #dcdcaa; --number: #b5cea8; --statusbar: #007acc; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Consolas', 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #workspace { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 300px; background-color: var(--sidebar-color); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; font-size: 11px; font-weight: bold; color: #bbb; display: flex; justify-content: space-between; }
        .search-box { padding: 10px; border-bottom: 1px solid #333; }
        input { width: 90%; background-color: #3c3c3c; border: 1px solid #3c3c3c; color: white; padding: 6px 8px; outline: none; font-family: inherit; }
        input:focus { border-color: var(--keyword); }
        #result-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .song-item { padding: 8px 15px; cursor: pointer; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 3px solid transparent; }
        .song-item:hover { background-color: #2a2d2e; } .song-item.active { background-color: #37373d; border-left-color: var(--keyword); }
        #main-container { flex: 1; display: flex; flex-direction: column; }
        #editor-upper { flex: 4; display: flex; flex-direction: column; border-bottom: 1px solid #333; }
        .tab-bar { background-color: #2d2d2d; height: 35px; display: flex; }
        .tab { background-color: var(--bg-color); padding: 0 15px; display: flex; align-items: center; font-size: 13px; border-top: 2px solid var(--keyword); color: white; }
        #fake-code-area { flex: 1; padding: 10px 20px; overflow-y: auto; font-size: 14px; line-height: 1.5; }
        #terminal-lower { flex: 6; background-color: var(--terminal-bg); display: flex; flex-direction: column; border-top: 1px solid #333; }
        .terminal-tabs { display: flex; background-color: #252526; height: 30px; align-items: center; padding-left: 10px; border-bottom: 1px solid #333; }
        .terminal-tab { font-size: 11px; color: #888; margin-right: 20px; cursor: pointer; }
        .terminal-tab.active { color: white; border-bottom: 1px solid white; }
        #console-output { flex: 1; padding: 15px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 18px; white-space: pre-wrap; color: #cccccc; }
        .console-line { margin-bottom: 6px; display: flex; line-height: 1.4; }
        .prompt { color: var(--keyword); margin-right: 10px; font-weight: bold; user-select: none;}
        .lyrics-text { color: #ce9178; transition: color 0.3s; }
        #status-bar { height: 22px; background-color: var(--statusbar); color: white; font-size: 12px; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; }
        .kw { color: var(--keyword); } .str { color: var(--string); } .cmt { color: var(--comment); } .cls { color: var(--class-name); } .mth { color: var(--method); } .num { color: var(--number); } .line-num { color: #858585; margin-right: 20px; user-select: none; text-align: right; display: inline-block; width: 30px;}
        .back-btn { position: absolute; top: 5px; right: 10px; background: #333; color: #fff; border: none; padding: 5px 10px; cursor: pointer; z-index: 100; font-family: inherit; font-size: 12px; }
        .back-btn:hover { background: #555; }
        
        /* í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #player-container {
            position: fixed; 
            bottom: 25px; 
            right: 10px; 
            width: 300px; 
            height: 200px; 
            z-index: 1000; 
            border: 2px solid #007acc; 
            background: #000; /* ë°°ê²½ì„ ê²€ì •ìœ¼ë¡œ */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #555;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="location.href='index.html'">ğŸ  Home</button>

    <div id="workspace">
        <div id="sidebar">
            <div class="sidebar-header"><span>EXPLORER</span><span>...</span></div>
            <div class="search-box"><input type="text" id="searchInput" placeholder="Search (Enter)" onkeypress="handleEnter(event)"></div>
            <ul id="result-list"><li class="song-item" style="color: gray;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li></ul>
        </div>
        <div id="main-container">
            <div id="editor-upper">
                <div class="tab-bar"><div class="tab"><span>ğŸµ MusicPlayer.java</span></div></div>
                <div id="fake-code-area"></div>
            </div>
            <div id="terminal-lower">
                <div class="terminal-tabs"><div class="terminal-tab">PROBLEMS</div><div class="terminal-tab">OUTPUT</div><div class="terminal-tab active">DEBUG CONSOLE</div><div class="terminal-tab">TERMINAL</div></div>
                <div id="console-output"><div class="console-line"><span class="prompt">player $</span><span>System Ready. Please select a song.</span></div></div>
            </div>
        </div>
    </div>
    <div id="status-bar"><div id="status-left">Ready</div><div id="status-right">Java 17 â€¢ UTF-8 â€¢ ğŸš€</div></div>

    <div id="player-container">
        <span>No Video Selected</span>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

<script>
    // --- 1. ë”ë¯¸ ì½”ë“œ ---
    const dummyCode = [`<span class="kw">public class</span> <span class="cls">MusicPlayer</span> {`, `    <span class="kw">public static void</span> <span class="mth">main</span>(String[] args) {`, `        <span class="cls">AudioStream</span> stream = <span class="kw">new</span> <span class="cls">AudioStream</span>();`, `        stream.<span class="mth">connect</span>(<span class="str">"YouTube_Server"</span>);`, `        <span class="cls">SyllableSync</span> sync = <span class="kw">new</span> <span class="cls">SyllableSync</span>();`, `        <span class="kw">while</span> (stream.<span class="mth">isPlaying</span>()) {`, `            <span class="cls">String</span> s = sync.<span class="mth">getNextSyllable</span>();`, `            <span class="kw">if</span> (s != <span class="kw">null</span>) <span class="cls">System</span>.out.<span class="mth">print</span>(s);`, `        }`, `    }`, `}`];
    function renderDummyCode() { document.getElementById('fake-code-area').innerHTML = dummyCode.map((line, i) => `<div><span class="line-num">${i + 1}</span>${line}</div>`).join(''); }
    renderDummyCode();

    // --- 2. ë¡œì§ ---
    let lyricsData = [];
    let player; // ìœ íŠœë¸Œ í”Œë ˆì´ì–´ ê°ì²´
    let syncInterval;
    let lastPrintedIndex = -1;
    let currentSyllableTimeouts = [];
    let currentLineElement = null; 

    function handleEnter(e) { if(e.key === 'Enter') searchMusic(); }

    async function searchMusic() {
        const query = document.getElementById('searchInput').value;
        if(!query) return;
        const list = document.getElementById('result-list');
        list.innerHTML = '<li class="song-item">Searching...</li>';
        try {
            const response = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            const validSongs = data.filter(song => song.syncedLyrics);
            list.innerHTML = '';
            if (validSongs.length === 0) { list.innerHTML = '<li class="song-item">No lyrics found.</li>'; return; }
            validSongs.forEach(song => {
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerHTML = `<span>ğŸµ ${song.artistName} - ${song.trackName}</span>`;
                li.onclick = () => {
                    document.querySelectorAll('.song-item').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    loadSong(song);
                };
                list.appendChild(li);
            });
        } catch (error) { list.innerHTML = '<li class="song-item">Error fetching data</li>'; }
    }

    function loadSong(song) {
        lyricsData = parseLrc(song.syncedLyrics);
        lastPrintedIndex = -1; 
        clearAllSyllableTimeouts();
        
        const consoleOut = document.getElementById('console-output');
        consoleOut.innerHTML = ''; 
        printToConsole(`> Loading: ${song.trackName}...`);
        
        // ì¬ìƒ ì‹œë„
        tryPlayMusic(song);
    }

    // [ìµœì¢… ìˆ˜ì •ëœ ì¬ìƒ í•¨ìˆ˜]
    // ë³µì¡í•œ ìë°”ìŠ¤í¬ë¦½íŠ¸ ëª…ë ¹ ëŒ€ì‹ , ê·¸ëƒ¥ HTML íƒœê·¸ë¥¼ í†µì§¸ë¡œ ê°ˆì•„ ë¼ì›ë‹ˆë‹¤.
    function tryPlayMusic(song) {
        // ê¸°ì¡´ í”Œë ˆì´ì–´ê°€ ìˆë‹¤ë©´ ë©”ëª¨ë¦¬ í•´ì œ ì‹œë„
        if(player && typeof player.destroy === 'function') {
            try { player.destroy(); } catch(e){}
        }

        // ê²€ìƒ‰ì–´ ìƒì„± (í•œê¸€ ê¹¨ì§ ë°©ì§€ ì²˜ë¦¬)
        const searchQ = encodeURIComponent(`${song.artistName} ${song.trackName} audio`);
        printToConsole(`> Searching: ${song.artistName} - ${song.trackName}`);

        // í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ ê°€ì ¸ì˜¤ê¸°
        const container = document.getElementById('player-container');
        
        // Iframe íƒœê·¸ ì§ì ‘ ì£¼ì… (ì´ ë°©ì‹ì€ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)
        // src ì£¼ì†Œì— listType=search ì™€ list=ê²€ìƒ‰ì–´ ë¥¼ ì§ì ‘ ë„£ìŠµë‹ˆë‹¤.
        container.innerHTML = `
            <iframe 
                id="youtube-iframe" 
                width="100%" 
                height="100%" 
                src="https://www.youtube.com/embed?listType=search&list=${searchQ}&autoplay=1&controls=1&enablejsapi=1&origin=${window.location.origin}" 
                frameborder="0" 
                allow="autoplay; encrypted-media" 
                allowfullscreen>
            </iframe>`;

        printToConsole("> Player injected. Waiting for API...");

        // ìœ íŠœë¸Œ API ì—°ê²° (ê°€ì‚¬ ì‹±í¬ë¥¼ ìœ„í•´ í•„ìš”)
        // ì•½ê°„ì˜ ì§€ì—° ì‹œê°„ì„ ì¤˜ì„œ iframeì´ ë¡œë”©ëœ í›„ ì—°ê²°
        setTimeout(() => {
            player = new YT.Player('youtube-iframe', {
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onError': (e) => printToConsole("YouTube Error Code: " + e.data)
                }
            });
        }, 1000);
    }

    // --- ê°€ì‚¬ íŒŒì‹± ë° ì‹±í¬ ---
    function parseLrc(lrc) {
        const lines = [];
        const regex = /\[(\d+):(\d+\.\d+)\](.*)/;
        lrc.split('\n').forEach(line => {
            const match = line.match(regex);
            if (match) lines.push({ time: parseInt(match[1]) * 60 + parseFloat(match[2]), text: match[3].trim() });
        });
        return lines;
    }

    function splitIntoSyllables(text) {
        const syllables = [];
        let currentSyllable = '';
        for (let char of text) {
            if (/[\u3131-\uD79D]/.test(char) || /[a-zA-Z0-9]/.test(char)) {
                if (currentSyllable) { syllables.push(currentSyllable); currentSyllable = ''; }
                syllables.push(char);
            } else {
                currentSyllable += char;
                if (syllables.length > 0) { syllables[syllables.length - 1] += char; currentSyllable = ''; }
            }
        }
        if (currentSyllable) syllables.push(currentSyllable);
        return syllables.filter(s => s.trim());
    }

    function printToConsole(text, isLyric = false) {
        const consoleOut = document.getElementById('console-output');
        const lineDiv = document.createElement('div');
        lineDiv.className = 'console-line';
        lineDiv.innerHTML = `<span class="prompt">></span> <span class="${isLyric ? 'lyrics-text' : ''}">${isLyric ? '' : text}</span>`;
        consoleOut.appendChild(lineDiv);
        consoleOut.scrollTop = consoleOut.scrollHeight;
        if (isLyric) currentLineElement = lineDiv.querySelector('.lyrics-text');
    }

    function clearAllSyllableTimeouts() {
        currentSyllableTimeouts.forEach(t => clearTimeout(t));
        currentSyllableTimeouts = [];
    }

    // --- ì‹±í¬ ì¡°ì ˆ ---
    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            document.getElementById('status-right').innerText = "Running (Music On) ğŸµ";
            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(checkSync, 50);
        } else if (event.data == YT.PlayerState.PAUSED) {
            clearInterval(syncInterval);
            clearAllSyllableTimeouts();
        }
    }

    function checkSync() {
        // player ê°ì²´ê°€ ìˆê³ , getCurrentTime í•¨ìˆ˜ê°€ ì‚´ì•„ìˆì„ ë•Œë§Œ ì‹¤í–‰
        if(!player || typeof player.getCurrentTime !== 'function' || lyricsData.length === 0) return;
        
        const currentTime = player.getCurrentTime();
        let activeIndex = -1;
        for(let i = 0; i < lyricsData.length; i++) {
            if (currentTime >= lyricsData[i].time) activeIndex = i; else break;
        }
        if(activeIndex !== -1 && activeIndex !== lastPrintedIndex) {
            clearAllSyllableTimeouts();
            displayLyricWithSyllables(activeIndex);
            lastPrintedIndex = activeIndex;
        }
    }

    function displayLyricWithSyllables(index) {
        const lyric = lyricsData[index];
        const syllables = splitIntoSyllables(lyric.text);
        let timeToNext = (index + 1 < lyricsData.length) ? (lyricsData[index + 1].time - lyric.time) : 2;
        let timePerSyllable = Math.max(0.05, Math.min(0.5, timeToNext / syllables.length));
        
        printToConsole('', true);
        syllables.forEach((s, i) => {
            currentSyllableTimeouts.push(setTimeout(() => {
                if (currentLineElement) {
                    currentLineElement.textContent += s;
                    document.getElementById('console-output').scrollTop = document.getElementById('console-output').scrollHeight;
                }
            }, i * timePerSyllable * 1000));
        });
    }
</script>
</body>
</html>
