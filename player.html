<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VS Code Lyric Console (Fixed)</title>
    <style>
        /* --- VS Code Dark Theme ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --terminal-bg: #1e1e1e;
            --text-color: #d4d4d4;
            --keyword: #569cd6; 
            --string: #ce9178;  
            --comment: #6a9955; 
            --class-name: #4ec9b0; 
            --method: #dcdcaa; 
            --number: #b5cea8; 
            --statusbar: #007acc;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ: ì‚¬ì´ë“œë°” + ì—ë””í„° */
        #workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ì‚¬ì´ë“œë°” */
        #sidebar {
            width: 300px;
            background-color: var(--sidebar-color);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: #bbb;
            display: flex;
            justify-content: space-between;
        }
        .search-box {
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        input {
            width: 90%;
            background-color: #3c3c3c;
            border: 1px solid #3c3c3c;
            color: white;
            padding: 6px 8px;
            outline: none;
            font-family: inherit;
        }
        input:focus { border-color: var(--keyword); }
        
        #result-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .song-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid transparent;
        }
        .song-item:hover { background-color: #2a2d2e; }
        .song-item.active { background-color: #37373d; border-left-color: var(--keyword); }

        /* ë©”ì¸ ì˜ì—­ */
        #main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ìƒë‹¨: ê°€ì§œ ì½”ë“œ ì—ë””í„° */
        #editor-upper {
            flex: 4; 
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #333;
        }
        .tab-bar {
            background-color: #2d2d2d;
            height: 35px;
            display: flex;
        }
        .tab {
            background-color: var(--bg-color);
            padding: 0 15px;
            display: flex;
            align-items: center;
            font-size: 13px;
            border-top: 2px solid var(--keyword);
            color: white;
        }
        #fake-code-area {
            flex: 1;
            padding: 10px 20px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        /* í•˜ë‹¨: í„°ë¯¸ë„ (ê°€ì‚¬ ì¶œë ¥) */
        #terminal-lower {
            flex: 6; /* ê°€ì‚¬ ì˜ì—­ì„ ë” ë„“ê²Œ */
            background-color: var(--terminal-bg);
            display: flex;
            flex-direction: column;
            border-top: 1px solid #333;
        }
        .terminal-tabs {
            display: flex;
            background-color: #252526;
            height: 30px;
            align-items: center;
            padding-left: 10px;
            border-bottom: 1px solid #333;
        }
        .terminal-tab {
            font-size: 11px;
            color: #888;
            margin-right: 20px;
            cursor: pointer;
        }
        .terminal-tab.active { color: white; border-bottom: 1px solid white; }

        #console-output {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 18px; /* ê°€ì‚¬ í°íŠ¸ í‚¤ì›€ */
            white-space: pre-wrap;
            color: #cccccc;
        }
        .console-line {
            margin-bottom: 6px;
            display: flex;
            line-height: 1.4;
        }
        .prompt { color: var(--keyword); margin-right: 10px; font-weight: bold; user-select: none;}
        .lyrics-text { color: #ce9178; /* ê°€ì‚¬ëŠ” ë¬¸ìì—´ ìƒ‰ìƒ(ì˜¤ë Œì§€) */ transition: color 0.3s;}
        .lyrics-text.highlight { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }

        /* í•˜ë‹¨ ìƒíƒœë°” */
        #status-bar {
            height: 22px;
            background-color: var(--statusbar);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            justify-content: space-between;
        }

        /* ìœ í‹¸ */
        .kw { color: var(--keyword); }
        .str { color: var(--string); }
        .cmt { color: var(--comment); }
        .cls { color: var(--class-name); }
        .mth { color: var(--method); }
        .num { color: var(--number); }
        .line-num { color: #858585; margin-right: 20px; user-select: none; text-align: right; display: inline-block; width: 30px;}

    </style>
</head>
<body>

    <div id="workspace">
        <div id="sidebar">
            <div class="sidebar-header">
                <span>EXPLORER</span>
                <span>...</span>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search (Enter)" onkeypress="handleEnter(event)">
            </div>
            <ul id="result-list">
                <li class="song-item" style="color: gray;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li>
            </ul>
        </div>

        <div id="main-container">
            <div id="editor-upper">
                <div class="tab-bar">
                    <div class="tab">
                        <span>ğŸµ MusicPlayer.java</span>
                    </div>
                </div>
                <div id="fake-code-area"></div>
            </div>

            <div id="terminal-lower">
                <div class="terminal-tabs">
                    <div class="terminal-tab">PROBLEMS</div>
                    <div class="terminal-tab">OUTPUT</div>
                    <div class="terminal-tab active">DEBUG CONSOLE</div>
                    <div class="terminal-tab">TERMINAL</div>
                </div>
                <div id="console-output">
                    <div class="console-line">
                        <span class="prompt">player $</span>
                        <span>Waiting for input...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="status-bar">
        <div id="status-left">Ready</div>
        <div id="status-right">Java 17 â€¢ UTF-8 â€¢ ğŸš€</div>
    </div>

    <div id="hidden-player"></div>
    <script src="https://www.youtube.com/iframe_api"></script>

<script>
        // --- 1. ë”ë¯¸ ì½”ë“œ ë Œë”ë§ (ì¥ì‹ìš©) ---
        const dummyCode = [
            `<span class="kw">package</span> com.vscode.music;`,
            ``,
            `<span class="kw">import</span> java.util.EmotionalEngine;`,
            ``,
            `<span class="kw">public class</span> <span class="cls">MusicPlayer</span> {`,
            `    <span class="kw">public static void</span> <span class="mth">main</span>(String[] args) {`,
            `        <span class="cmt">// 1. ìŒì•… ì—”ì§„ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</span>`,
            `        <span class="cls">AudioStream</span> stream = <span class="kw">new</span> <span class="cls">AudioStream</span>();`,
            `        stream.<span class="mth">connect</span>(<span class="str">"YouTube_Server"</span>);`,
            ``,
            `        <span class="cmt">// 2. ê°€ì‚¬ ë™ê¸°í™” ëª¨ë“ˆ ì‹œì‘</span>`,
            `        <span class="kw">while</span> (stream.<span class="mth">isPlaying</span>()) {`,
            `            <span class="cls">Lyric</span> lyric = stream.<span class="mth">getCurrentLyric</span>();`,
            `            <span class="kw">if</span> (lyric != <span class="kw">null</span>) {`,
            `                <span class="cls">System</span>.out.<span class="mth">println</span>(lyric);`,
            `            }`,
            `        }`,
            `    }`,
            `}`
        ];

        function renderDummyCode() {
            const area = document.getElementById('fake-code-area');
            let html = '';
            dummyCode.forEach((line, i) => {
                html += `<div><span class="line-num">${i + 1}</span>${line}</div>`;
            });
            area.innerHTML = html;
        }
        renderDummyCode();

        // --- 2. í”Œë ˆì´ì–´ ë¡œì§ ---
        let lyricsData = [];
        let player;
        let syncInterval;
        let lastPrintedIndex = -1;
        let currentTypeWriterTimeout = null;
        let loadTimeout = null; 
        let currentSongInfo = null; 

        function handleEnter(e) { if(e.key === 'Enter') searchMusic(); }

        async function searchMusic() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            
            const list = document.getElementById('result-list');
            list.innerHTML = '<li class="song-item">Searching...</li>';

            try {
                const response = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                const validSongs = data.filter(song => song.syncedLyrics);
                
                list.innerHTML = '';
                if (validSongs.length === 0) {
                    list.innerHTML = '<li class="song-item">No synced lyrics found.</li>';
                    return;
                }

                validSongs.forEach(song => {
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerHTML = `<span>ğŸµ ${song.artistName} - ${song.trackName}</span>`;
                    li.onclick = () => {
                        document.querySelectorAll('.song-item').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                        loadSong(song);
                    };
                    list.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                list.innerHTML = '<li class="song-item" style="color:#f44747;">Error fetching data</li>';
            }
        }

        function loadSong(song) {
            currentSongInfo = song; 
            lyricsData = parseLrc(song.syncedLyrics);
            lastPrintedIndex = -1; 
            if(currentTypeWriterTimeout) clearTimeout(currentTypeWriterTimeout);
            if(loadTimeout) clearTimeout(loadTimeout);

            const consoleOut = document.getElementById('console-output');
            consoleOut.innerHTML = ''; 
            
            printToConsole(`> Loading: ${song.trackName}...`);
            updateStatus(`Loading ${song.trackName}...`);

            tryPlayMusic(song);
        }

        function tryPlayMusic(song) {
            // [ì¤‘ìš” ìˆ˜ì •] ê°€ì‚¬ ë¹„ë””ì˜¤(lyrics)ë¡œ ê²€ìƒ‰ + ì—†ìœ¼ë©´ audio
            const searchQ = `${song.artistName} ${song.trackName} audio`;
            
            if(player && player.loadPlaylist) {
                player.loadPlaylist({
                    listType: 'search',
                    list: searchQ,
                    index: 0,
                    startSeconds: 0
                });
                player.setVolume(100);

                // 3ì´ˆ ëŒ€ê¸° í›„ ì²´í¬
                loadTimeout = setTimeout(() => {
                    if(player.getPlayerState() !== 1 && player.getPlayerState() !== 3) {
                         printManualPlayButton();
                    }
                }, 3000);
            }
        }

        function printManualPlayButton() {
            if(document.getElementById('manual-play-btn')) return;

            const consoleOut = document.getElementById('console-output');
            const lineDiv = document.createElement('div');
            lineDiv.id = 'manual-play-btn';
            lineDiv.className = 'console-line';
            lineDiv.style.cursor = 'pointer';
            lineDiv.style.color = '#4ec9b0'; 
            
            lineDiv.innerHTML = `<span class="prompt">!</span> <span style="text-decoration:underline;">[ System: ì¬ìƒ ê¶Œí•œ ìš”ì²­. í´ë¦­í•˜ì—¬ ì¬ìƒí•˜ê¸° ]</span>`;
            
            lineDiv.onclick = () => {
                if(player && currentSongInfo) {
                    printToConsole("> Retrying playback...");
                    lineDiv.style.display = 'none';
                    tryPlayMusic(currentSongInfo);
                }
            };
            
            consoleOut.appendChild(lineDiv);
            consoleOut.scrollTop = consoleOut.scrollHeight;
        }

        function parseLrc(lrc) {
            const lines = [];
            const regex = /\[(\d+):(\d+\.\d+)\](.*)/;
            lrc.split('\n').forEach(line => {
                const match = line.match(regex);
                if (match) {
                    lines.push({
                        time: parseInt(match[1]) * 60 + parseFloat(match[2]),
                        text: match[3].trim()
                    });
                }
            });
            return lines;
        }

        function printToConsole(text, isLyric = false) {
            const consoleOut = document.getElementById('console-output');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'console-line';
            
            const promptSpan = document.createElement('span');
            promptSpan.className = 'prompt';
            promptSpan.textContent = '>';
            
            const textSpan = document.createElement('span');
            textSpan.className = isLyric ? 'lyrics-text' : '';
            
            lineDiv.appendChild(promptSpan);
            lineDiv.appendChild(textSpan);
            consoleOut.appendChild(lineDiv);
            
            consoleOut.scrollTop = consoleOut.scrollHeight;

            if (isLyric) {
                typeWriter(textSpan, text, 0);
            } else {
                textSpan.textContent = text;
            }
        }

        function typeWriter(element, text, index) {
            const speed = Math.random() * 20 + 10; 
            if (index < text.length) {
                element.textContent += text.charAt(index);
                const consoleOut = document.getElementById('console-output');
                consoleOut.scrollTop = consoleOut.scrollHeight;

                currentTypeWriterTimeout = setTimeout(() => {
                    typeWriter(element, text, index + 1);
                }, speed);
            }
        }

        // --- 4. ìœ íŠœë¸Œ API (ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì •ë¨) ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('hidden-player', {
                height: '200', 
                width: '200',
                // videoIdë¥¼ ë¹„ì›Œë‘ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ, êµ¬ê¸€ ê°œë°œì ê³µì‹ ë¹„ë””ì˜¤ IDë¥¼ ë„£ì–´ ë‘  (ì´ˆê¸°í™”ìš©)
                videoId: 'M7lc1UVf-VE', 
                playerVars: { 
                    'autoplay': 0, // [ì¤‘ìš”] ì²˜ìŒì—” ìë™ì¬ìƒ ë„ê¸°
                    'controls': 1,
                    'origin': window.location.origin 
                },
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerError(event) {
            // ë…¸ë˜ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œì˜ ì—ëŸ¬ëŠ” ë¬´ì‹œ
            if (!currentSongInfo) return;

            if(event.data === 2) {
                // ì •ë§ ë…¸ë˜ë¥¼ í‹€ë‹¤ê°€ ë‚œ ì—ëŸ¬ë¼ë©´ ì¬ì‹œë„
                printToConsole("Warning: Connection Unstable (Error 2). Retrying...");
                setTimeout(() => tryPlayMusic(currentSongInfo), 2000);
            } else if (event.data === 150 || event.data === 101) {
                printToConsole("ERROR: Music blocked by copyright. Try another song.");
            } else {
                printToConsole("YouTube Error Code: " + event.data);
            }
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                updateStatus("Running (Playing Music)...");
                if(loadTimeout) clearTimeout(loadTimeout);
                
                const btn = document.getElementById('manual-play-btn');
                if(btn) btn.style.display = 'none';

                if(syncInterval) clearInterval(syncInterval);
                syncInterval = setInterval(checkSync, 100);
            } else if (event.data == YT.PlayerState.PAUSED) {
                updateStatus("Paused");
                clearInterval(syncInterval);
            }
        }

        function checkSync() {
            if(!player || !player.getCurrentTime || lyricsData.length === 0) return;
            
            const currentTime = player.getCurrentTime();
            let activeIndex = -1;
            for(let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if(activeIndex !== -1 && activeIndex !== lastPrintedIndex) {
                if(currentTypeWriterTimeout) clearTimeout(currentTypeWriterTimeout);
                printToConsole(lyricsData[activeIndex].text, true);
                lastPrintedIndex = activeIndex;
            }
        }

        function updateStatus(msg) {
            document.getElementById('status-left').innerText = msg;
        }
    </script>

</body>
</html>