<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyric Console: Enter</title>
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --btn-hover: #005f9e;
        }
        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Consolas', 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
        }

        /* --- 1. ëœë”© í˜ì´ì§€ (ì‹œì‘ í™”ë©´) ìŠ¤íƒ€ì¼ --- */
        #landing-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #2d2d2d 0%, #1e1e1e 100%);
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        .hero-title {
            font-size: 3rem; font-weight: bold; margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(0, 122, 204, 0.5);
        }
        .hero-subtitle {
            font-size: 1.2rem; color: #888; margin-bottom: 3rem;
            text-align: center; line-height: 1.5;
        }
        .btn-group { display: flex; gap: 20px; }
        .btn {
            padding: 15px 40px;
            font-size: 1.1rem; font-family: inherit; font-weight: bold;
            color: white; background-color: var(--accent-color);
            border: none; border-radius: 5px; cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn:hover { background-color: var(--btn-hover); transform: translateY(-2px); }
        .btn-outline {
            background-color: transparent; border: 2px solid var(--accent-color);
        }
        .btn-outline:hover { background-color: rgba(0, 122, 204, 0.1); }


        /* --- 2. VS Code í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ (ìˆ¨ê¹€ ì²˜ë¦¬ë¨) --- */
        #player-page {
            display: none; /* ì²˜ìŒì— ìˆ¨ê¹€ */
            height: 100%; width: 100%;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* (ê¸°ì¡´ í”Œë ˆì´ì–´ CSS ê·¸ëŒ€ë¡œ ìœ ì§€) */
        #workspace { display: flex; flex: 1; overflow: hidden; }
        #sidebar {
            width: 300px; background-color: #252526; border-right: 1px solid #333;
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 10px; font-size: 11px; font-weight: bold; color: #bbb;
            display: flex; justify-content: space-between;
        }
        .search-box { padding: 10px; border-bottom: 1px solid #333; }
        input {
            width: 90%; background-color: #3c3c3c; border: 1px solid #3c3c3c;
            color: white; padding: 6px 8px; outline: none; font-family: inherit;
        }
        input:focus { border-color: #007acc; }
        #result-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .song-item {
            padding: 8px 15px; cursor: pointer; font-size: 13px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 3px solid transparent;
        }
        .song-item:hover { background-color: #2a2d2e; }
        .song-item.active { background-color: #37373d; border-left-color: #007acc; }
        #main-container { flex: 1; display: flex; flex-direction: column; }
        #editor-upper { flex: 4; display: flex; flex-direction: column; border-bottom: 1px solid #333; }
        .tab-bar { background-color: #2d2d2d; height: 35px; display: flex; }
        .tab {
            background-color: #1e1e1e; padding: 0 15px; display: flex;
            align-items: center; font-size: 13px; border-top: 2px solid #007acc; color: white;
        }
        #fake-code-area { flex: 1; padding: 10px 20px; overflow-y: auto; font-size: 14px; line-height: 1.5; }
        .line-num { color: #858585; margin-right: 20px; user-select: none; text-align: right; display: inline-block; width: 30px;}
        .kw { color: #569cd6; } .str { color: #ce9178; }
        .cmt { color: #6a9955; } .cls { color: #4ec9b0; } .mth { color: #dcdcaa; }
        #terminal-lower { flex: 6; background-color: #1e1e1e; display: flex; flex-direction: column; border-top: 1px solid #333; }
        .terminal-tabs {
            display: flex; background-color: #252526; height: 30px;
            align-items: center; padding-left: 10px; border-bottom: 1px solid #333;
        }
        .terminal-tab { font-size: 11px; color: #888; margin-right: 20px; cursor: pointer; }
        .terminal-tab.active { color: white; border-bottom: 1px solid white; }
        #console-output {
            flex: 1; padding: 15px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 18px;
            white-space: pre-wrap; color: #cccccc;
        }
        .console-line { margin-bottom: 6px; display: flex; line-height: 1.4; }
        .prompt { color: #569cd6; margin-right: 10px; font-weight: bold; }
        .lyrics-text { color: #ce9178; transition: color 0.1s; }
        #status-bar {
            height: 22px; background-color: #007acc; color: white;
            font-size: 12px; display: flex; align-items: center;
            padding: 0 10px; justify-content: space-between;
        }
        /* ìœ íŠœë¸Œ í”Œë ˆì´ì–´ (ìš°ì¸¡ í•˜ë‹¨ ì‘ê²Œ ê³ ì •) */
        #player-container {
            position: fixed; bottom: 30px; right: 20px;
            width: 320px; height: 180px; z-index: 1000;
            border: 2px solid #007acc; background: #000;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none; /* ëœë”© í˜ì´ì§€ì—ì„  ì•ˆ ë³´ì„ */
        }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="hero-title">Lyric Console</div>
        <div class="hero-subtitle">
            ìŒì•…ì„ ì½”ë”©í•˜ë“¯ ê°ìƒí•˜ì„¸ìš”.<br>
            VS Code í…Œë§ˆì˜ ê°ì„±ì ì¸ ê°€ì‚¬ í”Œë ˆì´ì–´
        </div>
        <div class="btn-group">
            <button class="btn" onclick="enterPlayer()">ì²´í—˜í•˜ê¸°</button>
            <button class="btn btn-outline" onclick="shareLink()">ê³µìœ í•˜ê¸°</button>
        </div>
    </div>

    <div id="player-page">
        <div id="workspace">
            <div id="sidebar">
                <div class="sidebar-header"><span>EXPLORER</span><span>...</span></div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Song Title (Enter)" onkeypress="handleEnter(event)">
                </div>
                <ul id="result-list">
                    <li class="song-item" style="color: gray;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li>
                </ul>
            </div>
            <div id="main-container">
                <div id="editor-upper">
                    <div class="tab-bar"><div class="tab"><span>ğŸµ MusicPlayer.java</span></div></div>
                    <div id="fake-code-area"></div>
                </div>
                <div id="terminal-lower">
                    <div class="terminal-tabs">
                        <div class="terminal-tab">PROBLEMS</div>
                        <div class="terminal-tab">OUTPUT</div>
                        <div class="terminal-tab active">DEBUG CONSOLE</div>
                    </div>
                    <div id="console-output">
                        <div class="console-line"><span class="prompt">player $</span><span>System initialized.</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="status-bar">
            <div id="status-left">Ready</div>
            <div id="status-right">Java 17 â€¢ UTF-8 â€¢ <span id="player-status">Waiting...</span></div>
        </div>
    </div>

    <div id="player-container">
        <div id="hidden-player"></div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- [0] í™”ë©´ ì „í™˜ ë° ê³µìœ  ê¸°ëŠ¥ ---
        function enterPlayer() {
            const landing = document.getElementById('landing-page');
            const playerPage = document.getElementById('player-page');
            const playerContainer = document.getElementById('player-container');

            // í˜ì´ë“œ ì•„ì›ƒ/ì¸ íš¨ê³¼
            landing.style.opacity = '0';
            setTimeout(() => {
                landing.style.display = 'none';
                playerPage.style.display = 'flex';
                playerContainer.style.display = 'block';
                // ì•½ê°„ì˜ ë”œë ˆì´ í›„ í˜ì´ë“œ ì¸
                setTimeout(() => { playerPage.style.opacity = '1'; }, 50);
            }, 500);
        }

        function shareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”.');
            }).catch(() => {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            });
        }

        // --- [1] í”Œë ˆì´ì–´ ë¡œì§ (ì´ì „ ë²„ì „ ì™„ë²½ ì´ì‹) ---
        const dummyCode = [
            `<span class="kw">package</span> com.vscode.music;`,
            ``,
            `<span class="kw">public class</span> <span class="cls">MusicPlayer</span> {`,
            `    <span class="kw">public static void</span> <span class="mth">main</span>(String[] args) {`,
            `        <span class="cls">AudioStream</span> stream = <span class="kw">new</span> <span class="cls">AudioStream</span>();`,
            `        stream.<span class="mth">connect</span>(<span class="str">"YouTube_Server"</span>);`,
            `        <span class="kw">while</span> (stream.<span class="mth">isPlaying</span>()) {`,
            `            <span class="cls">System</span>.out.<span class="mth">print</span>(stream.<span class="mth">getLyric</span>());`,
            `        }`,
            `    }`,
            `}`
        ];
        document.getElementById('fake-code-area').innerHTML = dummyCode.map((l,i)=>`<div><span class="line-num">${i+1}</span>${l}</div>`).join('');

        let lyricsData = [], player, syncInterval, currentSongInfo, isRetrying = false;
        let lastPrintedIndex = -1, timeouts = [], loadTimeout, playerReady = false;

        function handleEnter(e) { if(e.key === 'Enter') searchMusic(); }

        async function searchMusic() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            const list = document.getElementById('result-list');
            list.innerHTML = '<li class="song-item">Searching...</li>';
            try {
                const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                const songs = data.filter(s => s.syncedLyrics);
                list.innerHTML = '';
                if(!songs.length) { list.innerHTML = '<li class="song-item">No synced lyrics found.</li>'; return; }
                songs.forEach(song => {
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.innerHTML = `ğŸµ ${song.artistName} - ${song.trackName}`;
                    li.onclick = () => {
                        document.querySelectorAll('.song-item').forEach(e => e.classList.remove('active'));
                        li.classList.add('active');
                        loadSong(song);
                    };
                    list.appendChild(li);
                });
            } catch(e) { list.innerHTML = '<li class="song-item">Error fetching data.</li>'; }
        }

        function loadSong(song) {
            currentSongInfo = song;
            lyricsData = parseLrc(song.syncedLyrics);
            lastPrintedIndex = -1;
            isRetrying = false;
            clearTimeouts();
            document.getElementById('console-output').innerHTML = '';
            printLog(`Selected: ${song.trackName} - ${song.artistName}`);
            document.getElementById('status-left').innerText = `Loading ${song.trackName}...`;
            tryPlay(song, false);
        }

        function tryPlay(song, useLyricsMode) {
            if(!playerReady) {
                printLog("Waiting for Player...");
                setTimeout(() => tryPlay(song, useLyricsMode), 1000);
                return;
            }
            const mode = useLyricsMode ? 'lyrics' : 'audio';
            const q = `${song.artistName} ${song.trackName} ${mode}`;
            printLog(`Searching YouTube (${mode}): ${q}`);

            if(player && player.loadPlaylist) {
                player.loadPlaylist({ listType: 'search', list: q, index: 0, startSeconds: 0 });
                player.setVolume(100);
            }

            if(loadTimeout) clearTimeout(loadTimeout);
            loadTimeout = setTimeout(() => {
                const state = player.getPlayerState();
                if(state !== 1 && state !== 3) showManualBtn();
            }, 4000);
        }

        function showManualBtn() {
            if(document.getElementById('manual-btn')) return;
            const div = document.createElement('div');
            div.id = 'manual-btn';
            div.className = 'console-line';
            div.style.color = '#4ec9b0'; div.style.cursor = 'pointer';
            div.innerHTML = `<span class="prompt">!</span> <span style="text-decoration:underline">[ System: ìë™ ì¬ìƒ ì°¨ë‹¨ë¨. í´ë¦­í•˜ì—¬ ì¬ìƒ ]</span>`;
            div.onclick = () => {
                div.style.display = 'none';
                printLog("Retrying playback (User Action)...");
                tryPlay(currentSongInfo, isRetrying);
            };
            document.getElementById('console-output').appendChild(div);
        }

        function parseLrc(lrc) {
            const lines = [];
            lrc.split('\n').forEach(line => {
                const m = line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
                if(m && m[3].trim()) lines.push({ time: parseInt(m[1])*60 + parseFloat(m[2]), text: m[3].trim() });
            });
            return lines;
        }

        function printLog(msg) {
            const div = document.createElement('div');
            div.className = 'console-line';
            div.innerHTML = `<span class="prompt">player $</span><span>${msg}</span>`;
            const consoleOut = document.getElementById('console-output');
            consoleOut.appendChild(div);
            consoleOut.scrollTop = consoleOut.scrollHeight;
        }

        function printLyric(text) {
            const div = document.createElement('div');
            div.className = 'console-line';
            div.innerHTML = `<span class="prompt">></span><span class="lyrics-text"></span>`; 
            const consoleOut = document.getElementById('console-output');
            consoleOut.appendChild(div);
            consoleOut.scrollTop = consoleOut.scrollHeight;
            const target = div.querySelector('.lyrics-text');
            const syllables = splitSyllables(text);
            const duration = 2000; 
            const step = Math.min(100, duration / syllables.length);
            syllables.forEach((s, i) => {
                const t = setTimeout(() => target.textContent += s, i * step);
                timeouts.push(t);
            });
        }
        function splitSyllables(text) {
            const res = []; let cur = '';
            for(let c of text) {
                if(/[\u3131-\uD79D]/.test(c) || /[a-zA-Z0-9]/.test(c)) {
                    if(cur) { res.push(cur); cur=''; } res.push(c);
                } else { cur += c; if(res.length) res[res.length-1]+=c; cur=''; }
            }
            if(cur) res.push(cur);
            return res;
        }
        function clearTimeouts() { timeouts.forEach(t=>clearTimeout(t)); timeouts = []; }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('hidden-player', {
                height: '100%', width: '100%',
                videoId: 'M7lc1UVf-VE',
                playerVars: { 'autoplay': 0, 'controls': 1, 'origin': window.location.origin },
                events: {
                    'onReady': () => { playerReady = true; document.getElementById('player-status').innerText = 'Player Ready'; },
                    'onStateChange': onStateChange,
                    'onError': onError
                }
            });
        }

        function onError(e) {
            if(!currentSongInfo) return;
            if(e.data === 150 || e.data === 101) {
                if(!isRetrying) {
                    printLog("! Audio blocked. Switching to Lyrics mode...");
                    isRetrying = true;
                    tryPlay(currentSongInfo, true);
                } else { printLog("Error: Content blocked."); }
            } else if (e.data === 2) {
                setTimeout(() => tryPlay(currentSongInfo, isRetrying), 2000);
            }
        }

        function onStateChange(e) {
            if(e.data === YT.PlayerState.PLAYING) {
                document.getElementById('status-left').innerText = "Playing: " + currentSongInfo.trackName;
                if(loadTimeout) clearTimeout(loadTimeout);
                const btn = document.getElementById('manual-btn');
                if(btn) btn.style.display = 'none';
                if(syncInterval) clearInterval(syncInterval);
                syncInterval = setInterval(checkSync, 100);
            }
        }

        function checkSync() {
            if(!player || !player.getCurrentTime) return;
            const t = player.getCurrentTime();
            let idx = -1;
            for(let i=0; i<lyricsData.length; i++) {
                if(t >= lyricsData[i].time) idx = i; else break;
            }
            if(idx !== -1 && idx !== lastPrintedIndex) {
                clearTimeouts();
                printLyric(lyricsData[idx].text);
                lastPrintedIndex = idx;
            }
        }
    </script>
</body>
</html>
