<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyric Console: Enter</title>
    <style>
        /* --- ê³µí†µ ì„¤ì • --- */
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-blue: #58a6ff;
            --btn-blue: #1f6feb;
            --code-bg: #161b22;
        }
        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            height: 100vh;
            overflow: hidden;
        }

        /* 1. ëœë”© í˜ì´ì§€ */
        #landing-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background-color: #0d1117;
            z-index: 2000;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .brand-logo {
            position: absolute; top: 20px; left: 30px;
            font-family: 'Consolas', monospace;
            font-size: 1.2rem; color: #58a6ff; font-weight: bold;
        }
        .hero-title {
            font-size: 3.5rem; font-weight: 800; margin-bottom: 1rem; color: #fff;
            text-align: center; letter-spacing: -1px;
        }
        .hero-desc {
            font-size: 1.1rem; color: #8b949e; margin-bottom: 2.5rem;
            text-align: center; line-height: 1.6;
        }
        .btn-group { display: flex; gap: 15px; margin-bottom: 40px; }
        .btn {
            padding: 12px 24px; font-size: 1rem; font-weight: 600;
            border-radius: 6px; cursor: pointer; border: 1px solid transparent;
            transition: 0.2s;
        }
        .btn-primary {
            background-color: #1f6feb; color: #fff;
        }
        .btn-primary:hover { background-color: #388bfd; }
        .btn-outline {
            background-color: transparent; border: 1px solid #30363d; color: #c9d1d9;
        }
        .btn-outline:hover { border-color: #8b949e; background-color: #161b22; }

        .code-preview-box {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 20px 30px;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #e6edf3;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .cp-cls { color: #ff7b72; }
        .cp-func { color: #d2a8ff; }
        .cp-str { color: #a5d6ff; }
        .cp-kw { color: #ff7b72; }
        .cp-dots { color: #8b949e; margin-bottom: 10px; display: block; font-size: 20px; line-height: 10px;}

        /* 2. VS Code í”Œë ˆì´ì–´ */
        #player-page {
            display: none;
            height: 100%; width: 100%;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.8s ease;
    position: relative;
    z-index: 1000;
        }

        :root {
            --vsc-bg: #1e1e1e;
            --vsc-sidebar: #252526;
            --vsc-terminal: #1e1e1e;
            --vsc-text: #d4d4d4;
            --vsc-keyword: #569cd6;
            --vsc-string: #ce9178;
            --vsc-bar: #007acc;
        }
#workspace {
    display: flex;
    flex: 1;
    min-height: 0;              /* ë‚´ë¶€ flex ìì‹ë“¤ì´ overflow-y ì‚¬ìš© ê°€ëŠ¥ */
    overflow: hidden;
    background-color: var(--vsc-bg);
    font-family: 'Consolas', monospace;
}

        }
        #sidebar {
            width: 300px; background-color: var(--vsc-sidebar);
            border-right: 1px solid #333; display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 10px; font-size: 11px; font-weight: bold; color: #bbb;
            display: flex; justify-content: space-between;
        }
        .search-box { padding: 10px; border-bottom: 1px solid #333; }
        input {
            width: 90%; background-color: #3c3c3c; border: 1px solid #3c3c3c;
            color: white; padding: 6px 8px; outline: none; font-family: inherit;
        }
        input:focus { border-color: var(--vsc-keyword); }
        #result-list {
            flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0;
        }
        .song-item {
            padding: 8px 15px; cursor: pointer; font-size: 13px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 3px solid transparent; color: var(--vsc-text);
        }
        .song-item:hover { background-color: #2a2d2e; }
        .song-item.active { background-color: #37373d; border-left-color: var(--vsc-keyword); }

        #main-container { flex: 1; display: flex; flex-direction: column; }
        #editor-upper {
            flex: 4; display: flex; flex-direction: column;
            border-bottom: 1px solid #333;
        }
        .tab-bar { background-color: #2d2d2d; height: 35px; display: flex; }
        .tab {
            background-color: var(--vsc-bg); padding: 0 15px;
            display: flex; align-items: center; font-size: 13px;
            border-top: 2px solid var(--vsc-keyword); color: white;
        }
        #fake-code-area {
            flex: 1; padding: 10px 20px;
            overflow-y: auto; font-size: 14px; line-height: 1.5; color: var(--vsc-text);
        }
        .line-num {
            color: #858585; margin-right: 20px; user-select: none;
            text-align: right; display: inline-block; width: 30px;
        }
        .kw { color: var(--vsc-keyword); }
        .str { color: var(--vsc-string); }
        .cls { color: #4ec9b0; }
        .mth { color: #dcdcaa; }
        .cmt { color: #6a9955; }

#terminal-lower {
    flex: 6;
    background-color: var(--vsc-terminal);
    display: flex;
    flex-direction: column;
    border-top: 1px solid #333;
    min-height: 0;              /* ìì‹ flex ì•„ì´í…œì´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
}
        .terminal-tabs {
            display: flex; background-color: #252526; height: 30px;
            align-items: center; padding-left: 10px; border-bottom: 1px solid #333;
        }
        .terminal-tab {
            font-size: 11px; color: #888; margin-right: 20px; cursor: pointer;
        }
        .terminal-tab.active { color: white; border-bottom: 1px solid white; }

#console-output {
    flex: 1;
    padding: 15px;
    min-height: 120px;          /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ê¸°ë³¸ ë†’ì´ */
    overflow-y: auto;           /* ìŠ¤í¬ë¡¤ ìƒì„± */
    -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
    font-family: 'Consolas', monospace;
    font-size: 18px;
    white-space: pre-wrap;
    color: #cccccc;
}
        .console-line {
            margin-bottom: 6px; display: flex; line-height: 1.4;
        }
        .prompt { color: var(--vsc-keyword); margin-right: 10px; font-weight: bold; }
        .lyrics-text { color: #ce9178; transition: color 0.1s; }

        #status-bar {
            height: 22px; background-color: var(--vsc-bar);
            color: white; font-size: 12px; display: flex;
            align-items: center; padding: 0 10px; justify-content: space-between;
        }

#player-container {
    position: fixed;
    bottom: 30px;
    right: 20px;
    width: 300px;
    height: 170px;
    z-index: 1000;
    border: 1px solid #007acc;
    background: #000;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    display: none;
}

/* ëª¨ë°”ì¼(ê°€ë¡œ 768px ì´í•˜)ì—ì„œëŠ” ë” ì‘ê²Œ, í™”ë©´ ì•„ë˜ë¡œ ë¶™ì´ê¸° */
@media (max-width: 768px) {
    #player-container {
        bottom: 0;
        right: 0;
        left: 0;
        margin: 0 auto;
        width: 100vw;          /* í™”ë©´ ê°€ë¡œ ê½‰ ì±„ìš°ë˜ */
        height: 35vh;          /* ì„¸ë¡œëŠ” 1/3 ì •ë„ë§Œ ì°¨ì§€ */
        z-index: 500;          /* VS Code ì˜ì—­ë³´ë‹¤ í•œ ë‹¨ê³„ ì•„ë˜ê±°ë‚˜ ë¹„ìŠ·í•˜ê²Œ */
    }
}

    </style>
</head>
<body>

<div id="landing-page">
    <div class="brand-logo">&lt;Lyric.java /&gt;</div>
    <div class="hero-title">ì½”ë“œë¡œ ë³´ëŠ” ê°€ì‚¬</div>
    <div class="hero-desc">
        ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ê°œë°œìì˜ ì–¸ì–´ë¡œ ì¬í•´ì„í•˜ì„¸ìš”.<br>
        ìŒì ˆ ë‹¨ìœ„ ì‹±í¬ì™€ VS Code ê°ì„±ì´ ë§Œë‚œ ìƒˆë¡œìš´ ê²½í—˜.
    </div>

    <div class="btn-group">
        <button class="btn btn-primary" onclick="startExperience()">ì§€ê¸ˆ ì‹œì‘í•˜ê¸°</button>
        <button class="btn btn-outline" onclick="shareLink()">ê³µìœ í•˜ê¸°</button>
    </div>

    <div class="code-preview-box">
        <span class="cp-dots">â— â— â—</span>
        <div><span class="cp-kw">class</span> Emotion {</div>
        <div>&nbsp;&nbsp;<span class="cp-kw">void</span> <span class="cp-func">playMusic</span>() {</div>
        <div>&nbsp;&nbsp;&nbsp;&nbsp;System.out.<span class="cp-func">println</span>(<span class="cp-str">"ğŸµ Music Start..."</span>);</div>
        <div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="cp-kw">return</span> <span class="cp-str">"Healing"</span>;</div>
        <div>&nbsp;&nbsp;}</div>
        <div>}</div>
    </div>
</div>

<div id="player-page">
    <div id="workspace">
        <div id="sidebar">
            <div class="sidebar-header"><span>EXPLORER</span><span>...</span></div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search (Enter)" onkeypress="handleEnter(event)">
            </div>
            <ul id="result-list">
                <li class="song-item" style="color: gray;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</li>
            </ul>
        </div>
        <div id="main-container">
            <div id="editor-upper">
                <div class="tab-bar"><div class="tab"><span>ğŸµ MusicPlayer.java</span></div></div>
                <div id="fake-code-area"></div>
            </div>
            <div id="terminal-lower">
                <div class="terminal-tabs">
                    <div class="terminal-tab">PROBLEMS</div>
                    <div class="terminal-tab">OUTPUT</div>
                    <div class="terminal-tab active">DEBUG CONSOLE</div>
                </div>
                <div id="console-output">
                    <div class="console-line"><span class="prompt">player $</span><span>Ready. System Initialized.</span></div>
                </div>
            </div>
        </div>
    </div>
    <div id="status-bar">
        <div id="status-left">Ready</div>
        <div id="status-right">Java 17 â€¢ UTF-8 â€¢ <span id="player-status">Waiting...</span></div>
    </div>
</div>

<div id="player-container">
    <div id="hidden-player"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* --- A. í™”ë©´ ì „í™˜ --- */
function startExperience() {
    const landing = document.getElementById('landing-page');
    const playerPage = document.getElementById('player-page');
    const playerContainer = document.getElementById('player-container');

    landing.style.opacity = '0';
    landing.style.transform = 'scale(0.95)';

    setTimeout(() => {
        landing.style.display = 'none';
        playerPage.style.display = 'flex';
        playerContainer.style.display = 'block';

        setTimeout(() => { playerPage.style.opacity = '1'; }, 50);

        if (player && player.getIframe()) {
            player.getIframe().dispatchEvent(new Event('resize'));
        }
    }, 500);
}

function shareLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }).catch(() => alert("ë³µì‚¬ ì‹¤íŒ¨"));
}

/* B. VS Code ê°€ì§œ ì½”ë“œ */
const dummyCode = [
    `<span class="kw">package</span> com.vscode.music;`,
    ``,
    `<span class="kw">import</span> java.util.EmotionalEngine;`,
    `<span class="kw">import</span> java.util.SyllableSync;`,
    ``,
    `<span class="kw">public class</span> <span class="cls">MusicPlayer</span> {`,
    `    <span class="kw">public static void</span> <span class="mth">main</span>(String[] args) {`,
    `        <span class="cmt">// 1. í”Œë ˆì´ì–´ ì—”ì§„ ì´ˆê¸°í™”</span>`,
    `        <span class="cls">AudioStream</span> stream = <span class="kw">new</span> <span class="cls">AudioStream</span>();`,
    `        <span class="cmt">// 2. ê°€ì‚¬ ì¶œë ¥ ë° ì‹±í¬</span>`,
    `        <span class="kw">while</span> (stream.<span class="mth">isPlaying</span>()) {`,
    `            <span class="cls">System</span>.out.<span class="mth">print</span>(stream.<span class="mth">getLyric</span>());`,
    `        }`,
    `    }`,
    `}`
];
document.getElementById('fake-code-area').innerHTML =
    dummyCode.map((l,i)=>`<div><span class="line-num">${i+1}</span>${l}</div>`).join('');

/* C. ìƒíƒœ ë³€ìˆ˜ë“¤ */
let lyricsData = [];
let player, syncInterval, currentSongInfo, isRetrying = false;
let lastPrintedIndex = -1, timeouts = [], playerReady = false;

function handleEnter(e) {
    if(e.key === 'Enter') searchMusic();
}

/* D. ê²€ìƒ‰ ë° LRC ë¡œë”© */
async function searchMusic() {
    const query = document.getElementById('searchInput').value;
    if(!query) return;

    const list = document.getElementById('result-list');
    list.innerHTML = '<li class="song-item">Searching...</li>';

    try {
        const res = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        const songs = data.filter(s => s.syncedLyrics);  // syncedLyrics ì‚¬ìš©[web:2][web:13]

        list.innerHTML = '';
        if(!songs.length) {
            list.innerHTML = '<li class="song-item">No synced lyrics found.</li>';
            return;
        }

        songs.forEach(song => {
            const li = document.createElement('li');
            li.className = 'song-item';
            li.innerHTML = `ğŸµ ${song.artistName} - ${song.trackName}`;
            li.onclick = () => {
                document.querySelectorAll('.song-item').forEach(e => e.classList.remove('active'));
                li.classList.add('active');
                loadSong(song);
            };
            list.appendChild(li);
        });
    } catch(e) {
        list.innerHTML = '<li class="song-item">Error fetching data.</li>';
    }
}

function loadSong(song) {
    if(syncInterval) { clearInterval(syncInterval); syncInterval = null; }
    if(player && player.stopVideo) {
        player.stopVideo();
    }

    currentSongInfo = song;
    lyricsData = parseLrc(song.syncedLyrics);   // LRC â†’ ë°°ì—´[web:2][web:13]
    lastPrintedIndex = -1;
    isRetrying = false;

    clearTimeouts();
    document.getElementById('console-output').innerHTML = '';

    printLog(`Selected: ${song.trackName} - ${song.artistName}`);
    document.getElementById('status-left').innerText = `Loading ${song.trackName}...`;

    tryPlay(song);
}

function tryPlay(song) {
    if(!playerReady) {
        printLog("Waiting for Player API...");
        setTimeout(() => tryPlay(song), 1000);
        return;
    }

    const q = `${song.artistName} ${song.trackName}`;
    printLog(`System: Searching '${q}'...`);

    if(player && player.loadPlaylist) {
        player.stopVideo();
        player.loadPlaylist({
            listType: 'search',
            list: q,
            index: 0,
            startSeconds: 0
        });
        setTimeout(() => { try { player.playVideo(); } catch(e){} }, 1000);
    }

    // íŠ¸ëŸ¬ë¸”ìŠˆíŠ¸ìš© ì•ˆë‚´ í´ë¦­
    setTimeout(() => {
        if (document.getElementById('manual-troubleshoot')) return;
        const div = document.createElement('div');
        div.id = 'manual-troubleshoot';
        div.className = 'console-line';
        div.style.cursor = 'pointer';
        div.style.color = '#ff7b72';
        div.innerHTML = `<span class="prompt">?</span> <span style="text-decoration:underline; font-weight:bold;">[Troubleshoot] ì˜ìƒì´ ë°”ë€Œì§€ ì•Šë‚˜ìš”? (í´ë¦­)</span>`;

        div.onclick = () => {
            const url = prompt("ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œ(URL)ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:\n(ì˜ˆ: https://youtu.be/...)");
            if(url) loadVideoFromUrl(url);
        };

        const out = document.getElementById('console-output');
        out.appendChild(div);
        out.scrollTop = out.scrollHeight;
    }, 1500);
}

function parseLrc(lrc) {
    const lines = [];
    lrc.split('\n').forEach(line => {
        const m = line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
        if(m && m[3].trim()) {
            lines.push({
                time: parseInt(m[1]) * 60 + parseFloat(m[2]),
                text: m[3].trim()
            });
        }
    });
    return lines;
}

/* E. ì½˜ì†” ì¶œë ¥ ê´€ë ¨ */
function printLog(msg) {
    const div = document.createElement('div');
    div.className = 'console-line';
    div.innerHTML = `<span class="prompt">player $</span><span>${msg}</span>`;
    const consoleOut = document.getElementById('console-output');
    consoleOut.appendChild(div);
    consoleOut.scrollTop = consoleOut.scrollHeight;
}

/* í•œ ì¤„ ì¶œë ¥: LRC ê°„ê²© ê¸°ë°˜ íƒ€ì´í•‘ */
function printLyricByIndex(idx) {
    const line = lyricsData[idx];
    const next = lyricsData[idx + 1];
    let durationMs;

    if (next) {
        durationMs = (next.time - line.time) * 1000; // ì´ˆ â†’ ms
    } else {
        durationMs = 2500; // ë§ˆì§€ë§‰ ì¤„ ê¸°ë³¸ê°’
    }

    // ë„ˆë¬´ ì§§ê±°ë‚˜ ë„ˆë¬´ ê¸´ ê²½ìš° ë³´ì •
    durationMs = Math.max(600, Math.min(4000, durationMs));
    printLyric(line.text, durationMs);
}

function printLyric(text, durationMs) {
    const div = document.createElement('div');
    div.className = 'console-line';
    div.innerHTML = `<span class="prompt">></span><span class="lyrics-text"></span>`;

    const consoleOut = document.getElementById('console-output');
    consoleOut.appendChild(div);
    consoleOut.scrollTop = consoleOut.scrollHeight;

    const target = div.querySelector('.lyrics-text');
    const syllables = splitSyllables(text);

    // ìµœì†Œ/ìµœëŒ€ step ì œí•œ
    let step = durationMs / Math.max(syllables.length, 1);
    step = Math.max(25, Math.min(120, step));

    syllables.forEach((s, i) => {
        const t = setTimeout(() => {
            target.textContent += s;
            consoleOut.scrollTop = consoleOut.scrollHeight;
        }, i * step);
        timeouts.push(t);
    });
}

function splitSyllables(text) {
    const res = [];
    let cur = '';
    for (let c of text) {
        if (/[\u3131-\uD79D]/.test(c) || /[a-zA-Z0-9]/.test(c)) {
            if (cur) {
                res.push(cur);
                cur = '';
            }
            res.push(c);
        } else {
            cur += c;
            if (res.length) res[res.length - 1] += c;
            cur = '';
        }
    }
    if (cur) res.push(cur);
    return res;
}

function clearTimeouts() {
    timeouts.forEach(t => clearTimeout(t));
    timeouts = [];
}

/* F. ìœ íŠœë¸Œ IFrame API */
function onYouTubeIframeAPIReady() {
    const currentOrigin = window.location.origin;

    player = new YT.Player('hidden-player', {
        height: '100%', width: '100%',
        videoId: 'kIiW3XRP7bU',
        playerVars: {
            autoplay: 0,
            controls: 1,
            rel: 0,
            origin: currentOrigin,
            enablejsapi: 1
        },
        events: {
            onReady: () => {
                playerReady = true;
                document.getElementById('player-status').innerText = 'Player Ready';
            },
            onStateChange: onStateChange,
            onError: onError
        }
    });
}

function onError(e) {
    printLog(`Error Code: ${e.data}. Trying fallback...`);
    if(currentSongInfo && !isRetrying) {
        isRetrying = true;
        printLog("âš ï¸ Video restricted or unavailable.");
    }
}

function onStateChange(e) {
    if(e.data === YT.PlayerState.PLAYING) {
        document.getElementById('status-left').innerText =
            "Playing: " + (currentSongInfo ? currentSongInfo.trackName : "Unknown");

        const btn = document.getElementById('manual-btn');
        if(btn) btn.style.display = 'none';

        if(syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(checkSync, 100);   // 0.1ì´ˆ ê°„ê²©[web:15]
    } else if (e.data === YT.PlayerState.ENDED || e.data === YT.PlayerState.PAUSED) {
        if(syncInterval) clearInterval(syncInterval);
    }
}

/* G. ì‹±í¬ ì²´í¬ */
function checkSync() {
    if(!player || !player.getCurrentTime) return;
    const t = player.getCurrentTime();
    let idx = -1;

    for(let i = 0; i < lyricsData.length; i++) {
        if(t >= lyricsData[i].time) idx = i;
        else break;
    }

    if(idx !== -1 && idx !== lastPrintedIndex) {
        clearTimeouts();
        printLyricByIndex(idx);
        lastPrintedIndex = idx;
    }
}

/* H. ìˆ˜ë™ URL ë¡œë”© */
function loadVideoFromUrl(url) {
    let videoId = null;

    if (url.includes('youtu.be/')) {
        videoId = url.split('youtu.be/')[1].split('?')[0];
    } else if (url.includes('v=')) {
        videoId = url.split('v=')[1].split('&')[0];
    } else if (url.includes('/embed/')) {
        videoId = url.split('/embed/')[1].split('?')[0];
    }

    if (videoId) {
        printLog(`Override: Loading Video ID [${videoId}]...`);
        if(player && player.loadVideoById) {
            player.stopVideo();
            player.loadVideoById(videoId);
            player.playVideo();

            if(syncInterval) clearInterval(syncInterval);
            lastPrintedIndex = -1;
        }
    } else {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ ìœ íŠœë¸Œ URLì…ë‹ˆë‹¤.");
    }
}
</script>
</body>
</html>
